<div class="row">
  <div class="col-sm-12">
    <div class="card">
      <div class="card-header">
        <h5>{{ isEditMode ? 'Editar' : 'Nueva' }} Lista de Precios</h5>
      </div>
      <div class="card-body">
        <form [formGroup]="priceListForm" (ngSubmit)="onSubmit()">

          @if (error) {
            <div class="alert alert-danger">{{ error }}</div>
          }

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" formControlName="name"
                [class.is-invalid]="priceListForm.get('name')?.invalid && priceListForm.get('name')?.touched">
              </div>
              <div class="col-md-3">
                <label class="form-label">Tipo</label>
                <select class="form-select" formControlName="type">
                  <option value="SALE">Venta (Clientes)</option>
                  <option value="PURCHASE">Compra (Proveedores)</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Moneda</label>
                <select class="form-select" formControlName="currency">
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="COP">COP</option>
                  <!-- Add more -->
                </select>
              </div>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" formControlName="active" id="activeCheck">
              <label class="form-check-label" for="activeCheck">Activa</label>
            </div>

            <hr>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6>Items (Reglas de Precio)</h6>
                @if (!isEditMode) {
                  <button type="button" class="btn btn-primary btn-sm" (click)="addItem()">
                    <i class="feather icon-plus"></i> Agregar Producto
                  </button>
                }
                @if (isEditMode) {
                  <div class="text-muted small">
                    La edición de items no está soportada en esta vista aún.
                  </div>
                }
              </div>

              @if (!isEditMode) {
                <div formArrayName="items">
                  @for (item of items.controls; track item; let i = $index) {
                    <div [formGroupName]="i"
                      class="row mb-2 align-items-end">
                      <div class="col-md-4">
                        @if (i===0) {
                          <label class="form-label small">Producto</label>
                        }
                        <select class="form-select" formControlName="product_id">
                          <option value="">Seleccionar Producto</option>
                          @for (p of products; track p) {
                            <option [value]="p.id">{{ p.name }}</option>
                          }
                        </select>
                      </div>
                      <div class="col-md-3">
                        @if (i===0) {
                          <label class="form-label small">Cant. Mínima</label>
                        }
                        <input type="number" class="form-control" formControlName="min_quantity" min="0">
                      </div>
                      <div class="col-md-3">
                        @if (i===0) {
                          <label class="form-label small">Precio/Costo</label>
                        }
                        <input type="number" class="form-control" formControlName="price" min="0">
                      </div>
                      <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeItem(i)">
                          <i class="feather icon-trash-2"></i>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }

              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-secondary me-2"
                [routerLink]="['/purchasing/pricelists']">Cancelar</button>
                <button type="submit" class="btn btn-primary" [disabled]="loading || priceListForm.invalid">
                  @if (loading) {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                  }
                  Guardar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>