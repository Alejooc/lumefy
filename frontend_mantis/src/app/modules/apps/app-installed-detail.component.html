@if (!loading && appDetail) {
  <div class="container-fluid py-4">
    <!-- App Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm app-header-card">
          <div class="card-body d-flex align-items-center gap-4 flex-wrap p-4">
            <div class="app-icon-wrapper">
              <div class="app-icon">
                <i class="feather" [ngClass]="appDetail.icon ? appDetail.icon : 'icon-box'"
                style="font-size: 2.2rem;"></i>
              </div>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 flex-wrap mb-1">
                <h3 class="mb-0">{{ appDetail.name }}</h3>
                <span class="badge bg-primary-subtle text-primary" style="font-size:.75rem;">
                  v{{ appDetail.version }}
                </span>
                <span class="badge bg-light text-dark" style="font-size:.75rem;">
                  Instalada: v{{ appDetail.installed_version }}
                </span>
                @if (appDetail.is_enabled) {
                  <span class="badge bg-success-subtle text-success">Activa</span>
                }
                @if (!appDetail.is_enabled) {
                  <span class="badge bg-danger-subtle text-danger">Desactivada</span>
                }
              </div>
              <p class="text-muted mb-1 small">{{ appDetail.description || 'Sin descripción.' }}</p>
              <p class="text-muted mb-0" style="font-size:.75rem;">
                <span class="me-3"><i class="feather icon-tag me-1"></i>{{ appDetail.category || 'General' }}</span>
                <span><i class="feather icon-code me-1"></i>{{ appDetail.slug }}</span>
              </p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-outline-secondary btn-sm" (click)="loadDetail()" [disabled]="loading">
                <i class="feather icon-refresh-cw me-1"></i>Refrescar
              </button>
              <button class="btn btn-outline-info btn-sm" (click)="runDemo()">
                <i class="feather icon-terminal me-1"></i>Debug
              </button>
              @if (supportsWebhooks()) {
                <button class="btn btn-outline-dark btn-sm" (click)="testWebhook()">
                  <i class="feather icon-send me-1"></i>Test Webhook
                </button>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Configuration Form -->
    <div class="row">
      <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom d-flex align-items-center gap-2">
            <i class="feather icon-settings text-primary"></i>
            <h5 class="mb-0">Configuración</h5>
          </div>
          <div class="card-body p-4">
            <!-- Dynamic fields from config_schema -->
            @if (schemaFields.length > 0) {
              @for (field of schemaFields; track field) {
                <div class="mb-4">
                  <!-- Boolean → Toggle switch -->
                  @if (field.type === 'boolean') {
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                      <div>
                        <label class="form-label mb-0 fw-semibold">{{ field.title }}</label>
                        @if (field.description) {
                          <p class="text-muted small mb-0">{{ field.description }}</p>
                        }
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" style="width:2.5rem; height:1.3rem;"
                          [id]="'field-' + field.key" [(ngModel)]="configForm[field.key]">
                        </div>
                      </div>
                    }
                    <!-- Enum → Select -->
                    @if (field.type === 'string' && field.enum) {
                      <label [for]="'field-' + field.key" class="form-label fw-semibold">{{ field.title }}</label>
                      @if (field.description) {
                        <p class="text-muted small mb-1">{{ field.description }}</p>
                      }
                      <select class="form-select" [id]="'field-' + field.key" [(ngModel)]="configForm[field.key]">
                        @for (opt of field.enum; track opt) {
                          <option [value]="opt">{{ opt }}</option>
                        }
                      </select>
                    }
                    <!-- Number → Input -->
                    @if (field.type === 'number' || field.type === 'integer') {
                      <label [for]="'field-' + field.key" class="form-label fw-semibold">{{ field.title }}</label>
                      @if (field.description) {
                        <p class="text-muted small mb-1">{{ field.description }}</p>
                      }
                      <input type="number" class="form-control" [id]="'field-' + field.key"
                        [(ngModel)]="configForm[field.key]">
                      }
                      <!-- Plain string → Input (no enum) -->
                      @if ((field.type === 'string' || !field.type) && !field.enum) {
                        <label [for]="'field-' + field.key" class="form-label fw-semibold">{{ field.title }}</label>
                        @if (field.description) {
                          <p class="text-muted small mb-1">{{ field.description }}</p>
                        }
                        <input type="text" class="form-control" [id]="'field-' + field.key" [(ngModel)]="configForm[field.key]">
                      }
                    </div>
                  }
                } @else {
                  <div class="text-center py-5">
                    <i class="feather icon-sliders text-muted" style="font-size: 3rem; opacity:.4;"></i>
                    <h6 class="text-muted mt-3">Sin campos de configuración definidos</h6>
                    <p class="text-muted small">El desarrollador de esta app no definió un esquema de configuración todavía.
                    </p>
                  </div>
                }
                <!-- No schema defined yet -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                  <!-- Raw JSON toggle -->
                  <button class="btn btn-link btn-sm text-muted p-0" (click)="showRawJson = !showRawJson">
                    <i class="feather icon-code me-1"></i>{{ showRawJson ? 'Ocultar' : 'Ver' }} JSON crudo
                  </button>
                  @if (schemaFields.length > 0) {
                    <button class="btn btn-primary" (click)="saveConfig()">
                      <i class="feather icon-save me-2"></i>Guardar configuración
                    </button>
                  }
                </div>
                <!-- Raw JSON accordion -->
                @if (showRawJson) {
                  <div class="mt-3">
                    <label class="form-label small fw-semibold text-muted">JSON de configuración actual</label>
                    <textarea class="form-control font-monospace" rows="10" [(ngModel)]="configEditor"
                    style="font-size:.8rem; background:#1e1e2e; color:#cdd6f4; border:none; border-radius:8px;"></textarea>
                    <div class="d-flex justify-content-end mt-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="saveRawJson()">
                        <i class="feather icon-save me-1"></i>Guardar JSON
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
          <!-- Info sidebar -->
          <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-white border-bottom">
                <h6 class="mb-0"><i class="feather icon-info me-2 text-muted"></i>Información de instalación</h6>
              </div>
              <div class="card-body px-4 py-3">
                <div class="info-row">
                  <span class="text-muted small">Instalada</span>
                  <span class="small fw-semibold">{{ appDetail.installed_at | date:'mediumDate' }}</span>
                </div>
                <div class="info-row">
                  <span class="text-muted small">ID de instalación</span>
                  <span class="small text-truncate fw-mono" style="max-width: 150px;" [title]="appDetail.install_id">{{
                  appDetail.install_id }}</span>
                </div>
                <div class="info-row">
                  <span class="text-muted small">Slug</span>
                  <code class="small">{{ appDetail.slug }}</code>
                </div>
                @if (appDetail.api_key_prefix) {
                  <div class="info-row">
                    <span class="text-muted small">API key prefix</span>
                    <code class="small">{{ appDetail.api_key_prefix }}</code>
                  </div>
                }
                @if (appDetail.oauth_client_id) {
                  <div class="info-row">
                    <span class="text-muted small">OAuth client_id</span>
                    <code class="small">{{ appDetail.oauth_client_id }}</code>
                  </div>
                }
                @if (supportsWebhooks()) {
                  <div class="info-row">
                    <span class="text-muted small">Webhook URL</span>
                    <span class="small fw-semibold">{{ appDetail.webhook_url || 'No configurado' }}</span>
                  </div>
                }
                @if (appDetail.granted_scopes.length > 0) {
                  <div class="info-row">
                    <span class="text-muted small">Scopes concedidos</span>
                    <span class="small fw-semibold">{{ appDetail.granted_scopes.join(', ') }}</span>
                  </div>
                }
                <div class="d-flex gap-2 mt-3">
                  <button class="btn btn-sm btn-outline-primary" (click)="rotateApiKey()">Rotar API key</button>
                  @if (supportsExternalApi()) {
                    <button class="btn btn-sm btn-outline-dark" (click)="rotateClientSecret()">Rotar client secret</button>
                  }
                  @if (supportsWebhooks()) {
                    <button class="btn btn-sm btn-outline-secondary" (click)="rotateWebhookSecret()">Rotar secret</button>
                  }
                </div>
              </div>
            </div>
            @if (billing) {
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-bottom">
                  <h6 class="mb-0"><i class="feather icon-credit-card me-2 text-muted"></i>Billing</h6>
                </div>
                <div class="card-body px-4 py-3">
                  <div class="info-row">
                    <span class="text-muted small">Modelo</span>
                    <span class="small fw-semibold">{{ billing.pricing_model }}</span>
                  </div>
                  <div class="info-row">
                    <span class="text-muted small">Costo mensual</span>
                    <span class="small fw-semibold">{{ billing.monthly_price }} {{ billing.currency }}</span>
                  </div>
                  <div class="info-row">
                    <span class="text-muted small">Estado</span>
                    <span class="small fw-semibold">{{ billing.billing_status }}</span>
                  </div>
                  @if (billing.next_invoice_date) {
                    <div class="info-row">
                      <span class="text-muted small">Proxima factura</span>
                      <span class="small fw-semibold">{{ billing.next_invoice_date | date:'mediumDate' }}</span>
                    </div>
                  }
                </div>
              </div>
            }
            @if (appDetail.capabilities.length > 0) {
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-bottom">
                  <h6 class="mb-0"><i class="feather icon-zap me-2 text-muted"></i>Capacidades</h6>
                </div>
                <div class="card-body px-4 py-3">
                  @for (capability of appDetail.capabilities; track capability) {
                    <span class="badge bg-light text-dark me-1 mb-1">
                      {{ capability }}
                    </span>
                  }
                </div>
              </div>
            }
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-white border-bottom">
                <h6 class="mb-0"><i class="feather icon-clock me-2 text-muted"></i>Eventos de lifecycle</h6>
              </div>
              <div class="card-body px-4 py-3">
                @if (events.length === 0) {
                  <div class="small text-muted">Aun no hay eventos registrados.</div>
                }
                @for (event of events; track event) {
                  <div class="border-bottom py-2">
                    <div class="d-flex justify-content-between gap-2">
                      <span class="small fw-semibold text-uppercase">{{ event.event_type }}</span>
                      <span class="small text-muted">{{ event.created_at | date:'short' }}</span>
                    </div>
                  </div>
                }
              </div>
            </div>
            @if (supportsWebhooks()) {
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-bottom">
                  <h6 class="mb-0"><i class="feather icon-link me-2 text-muted"></i>Webhook deliveries</h6>
                </div>
                <div class="card-body px-4 py-3">
                  @if (webhookDeliveries.length === 0) {
                    <div class="small text-muted">Sin entregas registradas.</div>
                  }
                  @for (delivery of webhookDeliveries; track delivery) {
                    <div class="border-bottom py-2">
                      <div class="d-flex justify-content-between align-items-center gap-2">
                        <div>
                          <div class="small fw-semibold">{{ delivery.event_name }}</div>
                          <div class="small text-muted">
                            intento {{ delivery.attempt_number }} | {{ delivery.created_at | date:'short' }}
                          </div>
                        </div>
                        <div class="text-end">
                          <span class="badge me-2" [class.bg-success]="delivery.success" [class.bg-danger]="!delivery.success">
                            {{ delivery.success ? 'OK' : 'FAIL' }}
                          </span>
                          @if (!delivery.success) {
                            <button class="btn btn-sm btn-outline-warning" (click)="retryWebhook(delivery.id)">
                              Retry
                            </button>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
            <!-- Schema preview -->
            @if (schemaFields.length > 0) {
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                  <h6 class="mb-0"><i class="feather icon-list me-2 text-muted"></i>Campos disponibles</h6>
                </div>
                <div class="card-body px-4 py-3">
                  @for (field of schemaFields; track field) {
                    <div class="d-flex justify-content-between align-items-center py-1">
                      <span class="small">{{ field.title }}</span>
                      <span class="badge bg-light text-muted" style="font-size: .7rem;">{{ field.type || 'string' }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    } @else {
      <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
        <div class="spinner-border text-primary" role="status"></div>
      </div>
    }

    <!-- Loading state -->
