<div class="row">
  <div class="col-sm-12">
    <app-card [cardTitle]="'Registrar Movimiento de Inventario'">
      <form [formGroup]="movementForm" (ngSubmit)="onSubmit()">

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Producto <span class="text-danger">*</span></label>
            <ng-select [items]="products" bindLabel="name" bindValue="id" formControlName="product_id"
              [typeahead]="productSearchInput$" [loading]="isLoading"
              placeholder="Buscar por nombre, SKU o código de barras"
              notFoundText="No se encontraron productos">
              <ng-template ng-option-tmp let-item="item">
                <div>
                  <span [ngClass]="{'fw-bold': true}">{{item.name}}</span>
                  <br>
                    <small class="text-muted">SKU: {{item.sku || 'N/A'}} | $ {{item.price}}</small>
                  </div>
                </ng-template>
              </ng-select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Sucursal <span class="text-danger">*</span></label>
              <ng-select [items]="branches" bindLabel="name" bindValue="id" formControlName="branch_id"
                placeholder="Seleccionar sucursal" notFoundText="No hay sucursales disponibles">
                <ng-template ng-option-tmp let-item="item">
                  <div>
                    <span class="fw-bold">{{item.name}}</span>
                    @if (item.address) {
                      <small class="text-muted ms-2">- {{item.address}}</small>
                    }
                  </div>
                </ng-template>
              </ng-select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Tipo de Movimiento <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="type">
                <option value="IN">Entrada (Compra/Devolución)</option>
                <option value="OUT">Salida (Venta/Merma)</option>
                <option value="ADJ">Ajuste (Corrección)</option>
                <option value="TRF">Transferencia</option>
              </select>
            </div>

            @if (movementForm.get('type')?.value === 'TRF') {
              <div class="col-md-4 mb-3">
                <label class="form-label">Sucursal Destino <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="destination_branch_id">
                  <option [ngValue]="null" disabled>Seleccione Destino</option>
                  @for (b of filteredBranches; track b) {
                    <option [value]="b.id">{{b.name}}</option>
                  }
                </select>
              </div>
            }

            <div class="col-md-4 mb-3">
              <label class="form-label">Cantidad <span class="text-danger">*</span></label>
              <input type="number" class="form-control" formControlName="quantity" min="0.001" step="0.01">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Referencia (Opcional)</label>
              <input type="text" class="form-control" formControlName="reference_id"
                placeholder="Ej. Factura #123">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Motivo (Opcional)</label>
              <textarea class="form-control" formControlName="reason" rows="2"
              placeholder="Describe el motivo del movimiento"></textarea>
            </div>

            <div class="d-flex flex-wrap gap-2">
              <button type="submit" class="btn btn-primary" [disabled]="movementForm.invalid || isSubmitting">
                @if (isSubmitting) {
                  <span class="spinner-border spinner-border-sm me-1" role="status"
                  aria-hidden="true"></span>
                }
                {{ isSubmitting ? 'Guardando...' : 'Guardar Movimiento' }}
              </button>
              <button type="button" class="btn btn-secondary" (click)="cancel()">Cancelar</button>
            </div>

          </form>
        </app-card>
      </div>
    </div>